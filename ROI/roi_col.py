import os
import sys

# [ì¤‘ìš”] ë¼ì¦ˆë² ë¦¬íŒŒì´ GUI ì¶©ëŒ ë°©ì§€ ì½”ë“œ (ë°˜ë“œì‹œ cv2 import ì „ì— ì‘ì„±)
os.environ["QT_QPA_PLATFORM"] = "xcb"

import cv2
import numpy as np

# -------------------------------------------------------------
# [ì„¤ì •] ì¢Œí‘œë¥¼ ë”°ê³  ì‹¶ì€ íŒŒì¼ ê²½ë¡œ (ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”!)
# -------------------------------------------------------------
IMAGE_PATH = "line.jpg"
# VIDEO_PATH = "test_video.avi"  # ë¹„ë””ì˜¤ë¥¼ ì“°ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ í›„ ì•„ë˜ ì½”ë“œ ìˆ˜ì •

points = []

def mouse_callback(event, x, y, flags, param):
    if event == cv2.EVENT_LBUTTONDOWN:
        points.append([x, y])
        print(f"ğŸ‘‰ ì°ì€ ì¢Œí‘œ: [{x}, {y}]")
        
        # ì°ì€ ìœ„ì¹˜ì— ë¹¨ê°„ ì  í‘œì‹œ
        cv2.circle(img, (x, y), 5, (0, 0, 255), -1)
        # ì ë“¤ì„ ì„ ìœ¼ë¡œ ì—°ê²° (ì‹œê°í™”)
        if len(points) > 1:
            cv2.line(img, tuple(points[-2]), tuple(points[-1]), (255, 0, 0), 2)
            
        cv2.imshow("Get Coordinates (Safe Mode)", img)

# -------------------------------------------------------------
# 1. ì´ë¯¸ì§€ ë¡œë“œ
# -------------------------------------------------------------
print(f"[Init] ì´ë¯¸ì§€ ë¡œë“œ ì¤‘... ({IMAGE_PATH})")
img = cv2.imread(IMAGE_PATH)

# (ë¹„ë””ì˜¤ë¥¼ ì‚¬ìš©í•  ê²½ìš° ì•„ë˜ 3ì¤„ ì£¼ì„ì„ í‘¸ì„¸ìš”)
# cap = cv2.VideoCapture(VIDEO_PATH)
# ret, img = cap.read()
# cap.release()

if img is None:
    print(f"\nâŒ [Error] ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
    print(f"   ê²½ë¡œ: {os.path.abspath(IMAGE_PATH)}")
    print("   íŒŒì¼ ì´ë¦„ì´ ë§ëŠ”ì§€, ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
    input("   (ì—”í„° í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì¢…ë£Œë©ë‹ˆë‹¤...)") # ë°”ë¡œ êº¼ì§ ë°©ì§€
    sys.exit()

print("------------------------------------------------")
print("âœ… ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ!")
print("1. ë§ˆìš°ìŠ¤ ì™¼ìª½ ë²„íŠ¼ìœ¼ë¡œ ê°ì§€í•˜ê³  ì‹¶ì€ êµ¬ì—­ì„ í´ë¦­í•˜ì„¸ìš”.")
print("   (ìˆœì„œ: ì™¼ìª½ìœ„ -> ì˜¤ë¥¸ìª½ìœ„ -> ì˜¤ë¥¸ìª½ì•„ë˜ -> ì™¼ìª½ì•„ë˜)")
print("2. ë‹¤ ì°ì—ˆìœ¼ë©´ í‚¤ë³´ë“œ 'q'ë¥¼ ëˆŒëŸ¬ ì¢…ë£Œí•˜ì„¸ìš”.")
print("------------------------------------------------")

# -------------------------------------------------------------
# 2. ìœˆë„ìš° ìƒì„± ë° ë§ˆìš°ìŠ¤ ì—°ê²°
# -------------------------------------------------------------
cv2.namedWindow("Get Coordinates (Safe Mode)")
cv2.setMouseCallback("Get Coordinates (Safe Mode)", mouse_callback)

cv2.imshow("Get Coordinates (Safe Mode)", img)

# í‚¤ ì…ë ¥ ëŒ€ê¸° (ë¬´í•œ ëŒ€ê¸°)
while True:
    key = cv2.waitKey(1) & 0xFF
    if key == ord('q'): # q ëˆ„ë¥´ë©´ ì¢…ë£Œ
        break

cv2.destroyAllWindows()

# -------------------------------------------------------------
# 3. ê²°ê³¼ ì¶œë ¥
# -------------------------------------------------------------
print("\n" + "="*50)
print("â†“â†“â†“ ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ parking_system_final.pyì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” â†“â†“â†“")
print("="*50)
print(f"MONITOR_ZONE = {points}")
print("="*50 + "\n")